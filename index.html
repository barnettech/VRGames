<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VR Pac-Rabbi Dungeon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- A-Frame (WebXR) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body { margin: 0; background: #000; }
  </style>
</head>
<body>
  <a-scene
    renderer="antialias: true"
    background="color: #101020"
    game-state
  >
    <!-- LIGHTS -->
    <a-entity light="type: ambient; intensity: 0.5; color: #ffffff"></a-entity>
    <a-entity light="type: point; intensity: 1.0; distance: 20; color: #ffd27f" position="0 5 0"></a-entity>

    <!-- DUNGEON FLOOR -->
    <a-plane rotation="-90 0 0" width="18" height="18" color="#222233"></a-plane>

    <!-- SIMPLE DUNGEON WALLS -->
    <a-box position="0 1 -8" depth="0.6" height="2" width="16" color="#3b3b5c"></a-box>
    <a-box position="0 1 8" depth="0.6" height="2" width="16" color="#3b3b5c"></a-box>
    <a-box position="-8 1 0" depth="16" height="2" width="0.6" color="#3b3b5c"></a-box>
    <a-box position="8 1 0" depth="16" height="2" width="0.6" color="#3b3b5c"></a-box>

    <!-- INNER WALLS TO MAKE A LITTLE MAZE -->
    <a-box position="0 1 0" depth="0.5" height="2" width="8" color="#303050"></a-box>
    <a-box position="-3 1 3" depth="0.5" height="2" width="8" rotation="0 90 0" color="#303050"></a-box>
    <a-box position="3 1 -3" depth="0.5" height="2" width="8" rotation="0 90 0" color="#303050"></a-box>

    <!-- PLAYER RIG (YOU) -->
    <!-- WASD on desktop, thumbstick + head look in Quest. Camera is child. -->
    <a-entity id="rig" wasd-controls="acceleration: 40" position="0 1.6 5">
      <a-entity camera look-controls>
        <!-- HUD attached to camera -->
        <a-entity id="hud" position="0 0 -1.5">
          <a-text id="scoreText" value="Score: 0"
                  color="yellow" width="2.5"
                  position="-0.8 0.35 0"></a-text>
          <a-text id="statusText" value=""
                  color="lightgreen" width="2.5"
                  position="-0.8 0.1 0"></a-text>
          <a-text id="hintText"
                  value="Collect yellow orbs. Grab hammer/sword/fly swatter to eat the ghosts!"
                  color="#ffffff" width="3"
                  position="-0.8 -0.2 0"></a-text>
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- GHOSTS (cute chasers) -->
    <a-sphere ghost="speed: 0.8" radius="0.4" color="#ff80c0" position="-4 1 0"></a-sphere>
    <a-sphere ghost="speed: 0.8" radius="0.4" color="#80ffc0" position="4 1 0"></a-sphere>
    <a-sphere ghost="speed: 0.9" radius="0.4" color="#80a0ff" position="0 1 -4"></a-sphere>

    <!-- POWERUPS (funny weapons) -->
    <!-- Hammer -->
    <a-box powerup="label: Hammer" position="-5 1 5" depth="0.2" height="0.4" width="0.8" color="#ffcc66">
      <a-box position="0 -0.4 0" depth="0.15" height="0.6" width="0.15" color="#8b5a2b"></a-box>
      <a-text value="Hammer" align="center" color="#ffffff" width="2" position="0 0.7 0"></a-text>
    </a-box>

    <!-- Sword -->
    <a-box powerup="label: Sword" position="5 1 -5" depth="0.1" height="0.8" width="0.2" color="#cccccc">
      <a-box position="0 -0.4 0" depth="0.2" height="0.2" width="0.6" color="#ffaa00"></a-box>
      <a-text value="Sword" align="center" color="#ffffff" width="2" position="0 0.7 0"></a-text>
    </a-box>

    <!-- Fly Swatter -->
    <a-box powerup="label: Fly Swatter" position="0 1 -6" depth="0.05" height="0.9" width="0.6" color="#66ffcc">
      <a-box position="0 -0.5 0" depth="0.1" height="0.5" width="0.15" color="#8b5a2b"></a-box>
      <a-text value="Fly Swatter" align="center" color="#ffffff" width="2" position="0 0.8 0"></a-text>
    </a-box>

    <!-- PELLETS (yellow dots to eat for points) -->
    <!-- You can add/remove pellets or change their positions to shape the maze path. -->
    <a-entity id="pellets">
      <!-- Row 1 -->
      <a-sphere pellet radius="0.12" color="#ffd800" position="-6 0.3 6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="-4 0.3 6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="-2 0.3 6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="0 0.3 6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="2 0.3 6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="4 0.3 6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="6 0.3 6"></a-sphere>

      <!-- Row 2 -->
      <a-sphere pellet radius="0.12" color="#ffd800" position="-6 0.3 3"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="-2 0.3 3"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="2 0.3 3"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="6 0.3 3"></a-sphere>

      <!-- Row 3 -->
      <a-sphere pellet radius="0.12" color="#ffd800" position="-6 0.3 0"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="-4 0.3 0"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="4 0.3 0"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="6 0.3 0"></a-sphere>

      <!-- Row 4 -->
      <a-sphere pellet radius="0.12" color="#ffd800" position="-6 0.3 -3"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="-2 0.3 -3"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="2 0.3 -3"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="6 0.3 -3"></a-sphere>

      <!-- Row 5 -->
      <a-sphere pellet radius="0.12" color="#ffd800" position="-6 0.3 -6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="-4 0.3 -6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="-2 0.3 -6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="0 0.3 -6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="2 0.3 -6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="4 0.3 -6"></a-sphere>
      <a-sphere pellet radius="0.12" color="#ffd800" position="6 0.3 -6"></a-sphere>
    </a-entity>

    <!-- SKY -->
    <a-sky color="#050510"></a-sky>
  </a-scene>

  <script>
    // Simple global game state
    const GameState = {
      score: 0,
      poweredUp: false,
      powerEndTime: 0
    };

    function updateScoreUI() {
      const scoreText = document.querySelector('#scoreText');
      if (scoreText) {
        scoreText.setAttribute('value', 'Score: ' + GameState.score);
      }
    }

    function setPoweredUp(durationMs, label) {
      const statusText = document.querySelector('#statusText');
      GameState.poweredUp = true;
      GameState.powerEndTime = performance.now() + durationMs;
      if (statusText) {
        statusText.setAttribute('value', 'POWER: ' + label + '!');
      }
    }

    function clearPoweredUp() {
      const statusText = document.querySelector('#statusText');
      GameState.poweredUp = false;
      if (statusText) {
        statusText.setAttribute('value', '');
      }
    }

    function flashHit() {
      const statusText = document.querySelector('#statusText');
      if (!statusText) return;
      const previous = statusText.getAttribute('value') || '';
      statusText.setAttribute('value', 'Ouch! Run!');
      setTimeout(() => {
        if (!GameState.poweredUp) {
          statusText.setAttribute('value', '');
        } else {
          statusText.setAttribute('value', previous || 'POWERED!');
        }
      }, 800);
    }

    // PELLET: small yellow spheres the player "eats" for points
    AFRAME.registerComponent('pellet', {
      init: function () {
        this.player = document.querySelector('#rig');
        this.collected = false;
        this.tempVec = new THREE.Vector3();
      },
      tick: function () {
        if (this.collected || !this.player) return;
        const playerPos = this.player.object3D.position;
        const pelletPos = this.el.object3D.position;
        this.tempVec.subVectors(playerPos, pelletPos);
        const dist = this.tempVec.length();
        if (dist < 0.6) {
          this.collected = true;
          GameState.score += 10;
          updateScoreUI();
          this.el.parentNode && this.el.parentNode.removeChild(this.el);
        }
      }
    });

    // POWERUP: grabbing it powers you up, so ghosts become edible
    AFRAME.registerComponent('powerup', {
      schema: {
        label: { default: 'Powerup' },
        duration: { default: 8000 } // ms
      },
      init: function () {
        this.player = document.querySelector('#rig');
        this.taken = false;
        this.tempVec = new THREE.Vector3();
      },
      tick: function () {
        if (this.taken || !this.player) return;
        const playerPos = this.player.object3D.position;
        const pos = this.el.object3D.position;
        this.tempVec.subVectors(playerPos, pos);
        const dist = this.tempVec.length();
        if (dist < 1.0) {
          this.taken = true;
          setPoweredUp(this.data.duration, this.data.label);
          // remove powerup from scene
          this.el.parentNode && this.el.parentNode.removeChild(this.el);
        }
      }
    });

    // GHOST: cute blob that chases the player
    AFRAME.registerComponent('ghost', {
      schema: {
        speed: { default: 0.7 }
      },
      init: function () {
        this.player = document.querySelector('#rig');
        this.tempVec = new THREE.Vector3();
      },
      tick: function (time, delta) {
        if (!this.player) return;

        const pos = this.el.object3D.position;
        const playerPos = this.player.object3D.position;

        // Move toward the player
        this.tempVec.subVectors(playerPos, pos);
        const dist = this.tempVec.length();

        if (dist > 0.1) {
          this.tempVec.normalize();
          const step = this.data.speed * (delta / 1000);
          pos.addScaledVector(this.tempVec, step);
        }

        // Collision with player
        if (dist < 0.9) {
          if (GameState.poweredUp) {
            // Player "eats" ghost: increase score and respawn ghost somewhere random
            GameState.score += 50;
            updateScoreUI();
            const newX = (Math.random() - 0.5) * 12;
            const newZ = (Math.random() - 0.5) * 12;
            pos.set(newX, 1, newZ);
          } else {
            // Player gets hit â€“ teleport back to start
            flashHit();
            this.player.object3D.position.set(0, 1.6, 5);
          }
        }
      }
    });

    // GAME STATE: handle timer for power-up expiring
    AFRAME.registerComponent('game-state', {
      tick: function (time, delta) {
        if (GameState.poweredUp && performance.now() > GameState.powerEndTime) {
          clearPoweredUp();
        }
      }
    });
  </script>
</body>
</html>